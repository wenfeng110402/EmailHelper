<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‚®ä»¶ç”»å¸ƒç¼–è¾‘å™¨</title>
    <style>
        :root {
            --bg: #eef1f5;
            --panel: #ffffff;
            --border: #d9dde4;
            --muted: #6b7280;
            --text: #111827;
            --brand: #5b7bff;
            --brand-2: #7c9bff;
            --danger: #f43f5e;
            --canvas-bg: #e3e2de;
            --shadow: 0 14px 40px rgba(15,23,42,0.12);
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fb 0%, #e8ecf5 60%, #e3eaf7 100%);
            color: var(--text);
            min-height: 100vh;
        }
        .topbar {
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            box-shadow: 0 6px 18px rgba(15,23,42,0.05);
        }
        .brand { font-weight: 700; font-size: 16px; letter-spacing: 0.2px; }
        .layout {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 14px;
            padding: 16px;
            min-height: calc(100vh - 64px);
        }
        .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
            box-shadow: var(--shadow);
        }
        h2 { margin: 0 0 10px 0; font-size: 15px; }
        .muted { color: var(--muted); font-size: 13px; }
        .palette-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .palette-item {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px;
            background: #f9fbff;
            cursor: grab;
            transition: all 0.15s ease;
        }
        .palette-item:hover { border-color: var(--brand); box-shadow: 0 10px 24px rgba(15,23,42,0.08); transform: translateY(-2px); }
        .palette-label { font-weight: 600; }
        .palette-desc { color: var(--muted); font-size: 12px; margin-top: 4px; }
        .canvas-shell {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 14px;
            box-shadow: var(--shadow);
            display: grid;
            gap: 10px;
        }
        .canvas-head { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
        .canvas-meta { color: var(--muted); font-size: 12px; }
        .toolbar { display: flex; gap: 8px; flex-wrap: wrap; }
        .pill {
            border: 1px solid var(--border);
            background: #f7f9ff;
            color: var(--text);
            border-radius: 999px;
            padding: 7px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.12s ease;
        }
        .pill:hover { border-color: var(--brand); color: var(--brand); }
        .pill.primary { background: linear-gradient(135deg, var(--brand), var(--brand-2)); color: #fff; border: none; font-weight: 700; }
        .canvas-wrap {
            background: var(--canvas-bg);
            border-radius: 14px;
            padding: 24px;
            min-height: calc(100vh - 140px);
            position: relative;
            overflow: hidden;
        }
        .canvas-wrap::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: linear-gradient(90deg, rgba(0,0,0,0.03) 1px, transparent 1px),
                                                linear-gradient(rgba(0,0,0,0.03) 1px, transparent 1px);
            background-size: 24px 24px;
            pointer-events: none;
        }
        .canvas {
            max-width: 640px;
            margin: 0 auto;
            background: #fff;
            border-radius: 14px;
            padding: 24px;
            box-shadow: 0 12px 32px rgba(15,23,42,0.10);
            position: relative;
            z-index: 1;
        }
        .logo { width: 64px; height: auto; margin-bottom: 16px; display: block; }
        .block {
            border: 1px dashed transparent;
            border-radius: 10px;
            padding: 8px;
            position: relative;
            margin: 8px 0;
            transition: all 0.12s ease;
        }
        .block:hover { border-color: #cbd5e1; background: #f7faff; }
        .block.selected { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(91,123,255,0.18); background: #f3f6ff; }
        .block-badge {
            position: absolute;
            top: -10px;
            left: 8px;
            background: #111827;
            color: #eef2ff;
            border-radius: 10px;
            padding: 4px 8px;
            font-size: 11px;
            letter-spacing: 0.2px;
        }
        .block-controls {
            position: absolute;
            top: -14px; right: -12px;
            display: flex; gap: 6px;
            opacity: 0;
            transition: opacity 0.18s ease;
            z-index: 10;
        }
        .block:hover .block-controls, .block.selected .block-controls { opacity: 1; }
        .btn {
            border: 1px solid var(--border);
            background: #f7f9ff;
            color: var(--text);
            border-radius: 10px;
            padding: 8px 11px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.12s ease;
        }
        .btn:hover { border-color: var(--brand); color: var(--brand); box-shadow: 0 8px 18px rgba(15,23,42,0.06); }
        .btn.primary { background: linear-gradient(135deg, var(--brand), var(--brand-2)); border: none; color: #fff; font-weight: 700; }
        .btn.danger { border-color: var(--danger); color: #fff; background: var(--danger); }
        .btn.full { width: 100%; }
        .input, .select, textarea.input {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #f9fbff;
            color: var(--text);
            margin-bottom: 10px;
            font-family: inherit;
        }
        .slider { width: 100%; }
        .label-row { display:flex; justify-content:space-between; align-items:center; font-size:12px; color: var(--muted); margin-bottom:6px; }
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            color: var(--muted);
            margin-top: 12px;
            background: #f9fbff;
        }
        .ai-box {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            background: #f9fbff;
            margin-top: 10px;
        }
        .tag { font-size: 11px; color: var(--muted); }
        .preview-html {
            width: 100%;
            min-height: 140px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: #0b0d12;
            color: #e5e7eb;
            padding: 12px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace;
            font-size: 12px;
        }
        .divider { height:1px; background: var(--border); margin: 14px 0; }
        .inline-btn { padding:6px 12px; border-radius: 999px; border:1px solid var(--border); background: #f7f9ff; color: var(--text); font-size:12px; cursor:pointer; }
        .inline-btn.active { border-color: var(--brand); color: var(--brand); background: #eef2ff; }
        .inline-btn:hover { border-color: var(--brand); color: var(--brand); }
        .inline-tip { font-size: 12px; color: var(--muted); margin: 4px 0 10px; }
    </style>
</head>
<body>
    <header class="topbar">
        <div class="brand">Canvas é£æ ¼ Â· é‚®ä»¶ç¼–è¾‘å™¨</div>
        <div class="toolbar">
            <button class="pill" onclick="addBlock('heading')">+ æ ‡é¢˜</button>
            <button class="pill" onclick="addBlock('paragraph')">+ æ­£æ–‡</button>
            <button class="pill" onclick="addBlock('image')">+ å›¾ç‰‡</button>
            <button class="pill" onclick="addBlock('button')">+ æŒ‰é’®</button>
            <button class="pill" onclick="addBlock('divider')">+ åˆ†éš”çº¿</button>
            <button class="pill" onclick="addBlock('spacer')">+ é—´è·</button>
            <button class="pill primary" onclick="copyHTML()">ğŸ“¦ å¯¼å‡º HTML</button>
        </div>
    </header>

    <main class="layout">
        <aside class="panel">
            <h2>ç»„ä»¶åº“</h2>
            <p class="muted" style="margin-bottom:10px;">æ‹–æ‹½æˆ–ç‚¹å‡»æ·»åŠ åˆ°ç”»å¸ƒï¼Œç±»ä¼¼ Canva çš„ç´ ææ ã€‚</p>
            <div class="palette-grid" id="palette"></div>
            <div class="drop-zone" id="dropZone">å°†å›¾ç‰‡æ–‡ä»¶æ‹–æ‹½åˆ°æ­¤ä¸Šä¼ ï¼Œè‡ªåŠ¨æ·»åŠ åˆ°ç”»å¸ƒ</div>
        </aside>

        <section class="canvas-shell">
            <div class="canvas-head">
                <div>
                    <div style="font-size:13px; font-weight:600;">ç”»å¸ƒ (600px é‚®ä»¶å®½åº¦)</div>
                    <div class="canvas-meta">èƒŒæ™¯è‰² #E3E2DE Â· å¯è§†åŒ–æ’ç‰ˆ</div>
                </div>
                <div class="toolbar">
                    <button class="pill" onclick="addBlock('heading')">æ ‡é¢˜</button>
                    <button class="pill" onclick="addBlock('paragraph')">æ­£æ–‡</button>
                    <button class="pill" onclick="addBlock('image')">å›¾ç‰‡</button>
                    <button class="pill" onclick="addBlock('button')">æŒ‰é’®</button>
                    <button class="pill" onclick="addBlock('divider')">åˆ†éš”çº¿</button>
                    <button class="pill" onclick="addBlock('spacer')">é—´è·</button>
                </div>
            </div>
            <div class="canvas-wrap">
                <div class="canvas" id="canvas" ondragover="event.preventDefault()" ondrop="handleDrop(event)">
                    <img src="https://cloudflare-imgbed-1g1.pages.dev/file/eb403447697894cceee15.jpg" class="logo" alt="Logo">
                    <div id="blocks"></div>
                </div>
            </div>
        </section>

        <aside class="panel">
            <h2>å±æ€§é¢æ¿</h2>
            <p class="muted" style="margin-bottom:8px;">ç‚¹å‡»ç”»å¸ƒå…ƒç´ ç¼–è¾‘æ ·å¼ï¼Œå³ä¸Šè§’å¯ç§»åŠ¨/å¤åˆ¶/åˆ é™¤ã€‚</p>
            <div id="propPanel">
                <p class="muted">é€‰æ‹©ç”»å¸ƒä¸­çš„å…ƒç´ ä»¥ç¼–è¾‘ã€‚</p>
            </div>
            <div class="divider"></div>
            <h2>AI åŠ©æ‰‹</h2>
            <div class="ai-box">
                <input class="input" id="apiKey" type="password" placeholder="OpenAI API Key (sk-...)" />
                <textarea class="input" id="aiPrompt" placeholder="æè¿°ä½ æƒ³ä¼˜åŒ–çš„å†…å®¹ï¼Œå¦‚ï¼šæ¶¦è‰²è¿™æ®µé‚®ä»¶"></textarea>
                <div class="label-row"><span class="tag">æ¨¡å‹</span><span class="muted">gpt-4o-mini</span></div>
                <button class="btn primary full" onclick="runAI()">âš¡ AI æ”¹å†™é€‰ä¸­å—</button>
                <p class="muted" style="margin-top:6px;">è‹¥æœªé€‰ä¸­å—ï¼ŒAI ä¼šè¿½åŠ ä¸€ä¸ªæ–°æ®µè½ã€‚</p>
            </div>
            <div class="divider"></div>
            <button class="btn primary full" onclick="copyHTML()">ğŸ“¦ å¯¼å‡º/å¤åˆ¶ HTML</button>
            <p class="inline-tip">å¯¼å‡ºå†…å®¹ä¸ºé‚®ä»¶å®‰å…¨ HTMLï¼Œä¸å«å¤šä½™è„šæœ¬ã€‚</p>
            <textarea class="preview-html" id="htmlOutput" readonly></textarea>
        </aside>
    </main>

    <script>
        const paletteItems = [
            { type: 'heading', label: 'æ ‡é¢˜', desc: 'å¤§å­—å·å¼ºè°ƒ' },
            { type: 'paragraph', label: 'æ­£æ–‡', desc: 'æ­£æ–‡æ®µè½' },
            { type: 'image', label: 'å›¾ç‰‡', desc: 'ä¸Šä¼ æˆ–é“¾æ¥' },
            { type: 'button', label: 'æŒ‰é’®', desc: 'CTA è¡ŒåŠ¨æŒ‰é’®' },
            { type: 'divider', label: 'åˆ†éš”çº¿', desc: 'è§†è§‰åˆ†å‰²' },
            { type: 'spacer', label: 'é—´è·', desc: 'ç•™ç™½æ§è·' }
        ];

        const palette = document.getElementById('palette');
        paletteItems.forEach(item => {
            const el = document.createElement('div');
            el.className = 'palette-item';
            el.draggable = true;
            el.dataset.type = item.type;
            el.innerHTML = `<div class="palette-label">${item.label}</div><div class="palette-desc">${item.desc}</div>`;
            el.ondragstart = e => e.dataTransfer.setData('type', item.type);
            el.onclick = () => addBlock(item.type);
            palette.appendChild(el);
        });

        let blocks = [];
        let selectedId = null;

        function addBlock(type) {
            const id = 'b-' + Math.random().toString(36).slice(2, 8);
            const base = {
                id,
                type,
                content: type === 'heading' ? 'é‚®ä»¶æ ‡é¢˜' : type === 'button' ? 'ç«‹å³è¡ŒåŠ¨' : type === 'image' ? 'https://via.placeholder.com/600x200/ddd/555?text=Image' : 'è¾“å…¥æ–‡æœ¬...',
                styles: {
                    fontSize: type === 'heading' ? 24 : 15,
                    fontWeight: type === 'heading' ? 700 : 400,
                    color: '#1d1d1f',
                    align: 'left',
                    padding: 10,
                    marginY: 8,
                    width: type === 'image' ? 100 : null,
                    buttonBg: '#0b66ff',
                    buttonColor: '#ffffff'
                }
            };
            blocks.push(base);
            render();
            selectBlock(id);
        }

        function handleDrop(e) {
            e.preventDefault();
            const type = e.dataTransfer.getData('type');
            if (type) addBlock(type);
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                const file = e.dataTransfer.files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        const id = 'b-' + Math.random().toString(36).slice(2, 8);
                        blocks.push({ id, type:'image', content: ev.target.result, styles:{ width: 100, padding:10, marginY:8 } });
                        render();
                        selectBlock(id);
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function render() {
            const wrap = document.getElementById('blocks');
            wrap.innerHTML = '';
            blocks.forEach(b => {
                const div = document.createElement('div');
                div.className = 'block' + (selectedId === b.id ? ' selected' : '');
                div.onclick = () => selectBlock(b.id);

                const badge = document.createElement('div');
                badge.className = 'block-badge';
                badge.textContent = b.type.toUpperCase();

                const inner = document.createElement('div');
                inner.contentEditable = ['heading','paragraph','button'].includes(b.type);
                inner.oninput = e => editContent(b.id, e.target.innerText);
                inner.style.padding = `${b.styles.padding || 0}px`;
                inner.style.margin = `${b.styles.marginY || 0}px 0`;
                inner.style.textAlign = b.styles.align || 'left';

                if (b.type === 'heading') {
                    inner.style.fontSize = `${b.styles.fontSize || 24}px`;
                    inner.style.fontWeight = b.styles.fontWeight || 700;
                    inner.style.color = b.styles.color || '#1d1d1f';
                    inner.innerText = b.content;
                }
                if (b.type === 'paragraph') {
                    inner.style.fontSize = `${b.styles.fontSize || 15}px`;
                    inner.style.fontWeight = b.styles.fontWeight || 400;
                    inner.style.color = b.styles.color || '#1d1d1f';
                    inner.style.lineHeight = 1.6;
                    inner.innerText = b.content;
                }
                if (b.type === 'image') {
                    inner.contentEditable = false;
                    inner.innerHTML = `<img src="${b.content}" style="max-width:${b.styles.width || 100}%; border-radius: 12px; display:block; margin:0 auto;">`;
                }
                if (b.type === 'button') {
                    inner.style.textAlign = b.styles.align || 'left';
                    inner.innerHTML = `<a href="#" style="display:inline-block; padding: 12px 18px; border-radius: 12px; background:${b.styles.buttonBg}; color:${b.styles.buttonColor}; font-size:${b.styles.fontSize || 15}px; font-weight:${b.styles.fontWeight || 600}; text-decoration:none;">${b.content}</a>`;
                }
                if (b.type === 'divider') {
                    inner.contentEditable = false;
                    inner.innerHTML = `<div style="height:1px; background:#e0e0e0; width:100%;"></div>`;
                }
                if (b.type === 'spacer') {
                    inner.contentEditable = false;
                    inner.innerHTML = `<div style="height:${b.styles.height || 16}px;"></div>`;
                }

                const ctrls = document.createElement('div');
                ctrls.className = 'block-controls';
                ctrls.innerHTML = `
                    <button class="btn" style="padding:4px 6px;" onclick="event.stopPropagation(); moveBlock('${b.id}', -1)">â†‘</button>
                    <button class="btn" style="padding:4px 6px;" onclick="event.stopPropagation(); moveBlock('${b.id}', 1)">â†“</button>
                    <button class="btn" style="padding:4px 6px;" onclick="event.stopPropagation(); duplicateBlock('${b.id}')">â§‰</button>
                    <button class="btn danger" style="padding:4px 6px;" onclick="event.stopPropagation(); deleteBlock('${b.id}')">âœ•</button>
                `;

                div.appendChild(badge);
                div.appendChild(ctrls);
                div.appendChild(inner);
                wrap.appendChild(div);
            });
            updateHTML();
        }

        function selectBlock(id) {
            selectedId = id;
            renderProps();
            render();
        }

        function editContent(id, text) {
            const b = blocks.find(x => x.id === id);
            if (b) { b.content = text; updateHTML(); }
        }

        function moveBlock(id, delta) {
            const idx = blocks.findIndex(b => b.id === id);
            if (idx < 0) return;
            const newIdx = idx + delta;
            if (newIdx < 0 || newIdx >= blocks.length) return;
            const [item] = blocks.splice(idx, 1);
            blocks.splice(newIdx, 0, item);
            render();
            selectBlock(id);
        }

        function duplicateBlock(id) {
            const idx = blocks.findIndex(b => b.id === id);
            if (idx < 0) return;
            const copy = JSON.parse(JSON.stringify(blocks[idx]));
            copy.id = 'b-' + Math.random().toString(36).slice(2, 8);
            blocks.splice(idx + 1, 0, copy);
            render();
            selectBlock(copy.id);
        }

        function deleteBlock(id) {
            blocks = blocks.filter(b => b.id !== id);
            selectedId = null;
            render();
            renderProps();
        }

        function renderProps() {
            const panel = document.getElementById('propPanel');
            const b = blocks.find(x => x.id === selectedId);
            if (!b) { panel.innerHTML = '<p class="muted">æœªé€‰æ‹©å…ƒç´ ã€‚</p>'; return; }

            panel.innerHTML = `
                <div class="label-row"><span>${b.type.toUpperCase()}</span><span class="tag">ID ${b.id}</span></div>
                ${['heading','paragraph','button'].includes(b.type) ? `
                    <div class="label-row"><span>æ–‡å­—</span></div>
                    <textarea class="input" oninput="editContent('${b.id}', this.value)">${b.content}</textarea>
                    <div class="label-row"><span>å­—ä½“å¤§å°</span><span>${b.styles.fontSize || 14}px</span></div>
                    <input class="slider" type="range" min="12" max="44" value="${b.styles.fontSize || 14}" oninput="updateStyle('${b.id}','fontSize', this.value)">
                    <div class="label-row"><span>ç²—ç»†</span><span>${b.styles.fontWeight || 400}</span></div>
                    <input class="slider" type="range" min="300" max="800" step="100" value="${b.styles.fontWeight || 400}" oninput="updateStyle('${b.id}','fontWeight', this.value)">
                    <div class="label-row"><span>é¢œè‰²</span></div>
                    <input class="input" type="color" value="${b.styles.color || '#1d1d1f'}" oninput="updateStyle('${b.id}','color', this.value)">
                ` : ''}
                ${b.type === 'image' ? `
                    <div class="label-row"><span>å›¾ç‰‡ URL</span></div>
                    <input class="input" value="${b.content}" oninput="updateContent('${b.id}', this.value)">
                    <div class="label-row"><span>å®½åº¦ %</span><span>${b.styles.width || 100}%</span></div>
                    <input class="slider" type="range" min="20" max="100" value="${b.styles.width || 100}" oninput="updateStyle('${b.id}','width', this.value)">
                    <input type="file" accept="image/*" class="input" onchange="uploadImg(event, '${b.id}')">
                ` : ''}
                ${b.type === 'button' ? `
                    <div class="label-row"><span>æŒ‰é’®èƒŒæ™¯</span></div>
                    <input class="input" type="color" value="${b.styles.buttonBg || '#0b66ff'}" oninput="updateStyle('${b.id}','buttonBg', this.value)">
                    <div class="label-row"><span>æ–‡å­—é¢œè‰²</span></div>
                    <input class="input" type="color" value="${b.styles.buttonColor || '#ffffff'}" oninput="updateStyle('${b.id}','buttonColor', this.value)">
                ` : ''}
                ${b.type === 'spacer' ? `
                    <div class="label-row"><span>é«˜åº¦</span><span>${b.styles.height || 16}px</span></div>
                    <input class="slider" type="range" min="8" max="120" value="${b.styles.height || 16}" oninput="updateStyle('${b.id}','height', this.value)">
                ` : ''}
                <div class="label-row"><span>å¯¹é½</span></div>
                <div class="toolbar">
                    ${['left','center','right'].map(a => `<button class="inline-btn ${b.styles.align===a?'active':''}" onclick="updateStyle('${b.id}','align','${a}')">${a}</button>`).join('')}
                </div>
                <div class="label-row"><span>å†…è¾¹è·</span><span>${b.styles.padding || 0}px</span></div>
                <input class="slider" type="range" min="0" max="30" value="${b.styles.padding || 0}" oninput="updateStyle('${b.id}','padding', this.value)">
                <div class="label-row"><span>ä¸Šä¸‹é—´è·</span><span>${b.styles.marginY || 0}px</span></div>
                <input class="slider" type="range" min="0" max="40" value="${b.styles.marginY || 0}" oninput="updateStyle('${b.id}','marginY', this.value)">
            `;
        }

        function updateContent(id, val) {
            const b = blocks.find(x => x.id === id);
            if (b) { b.content = val; render(); }
        }

        function updateStyle(id, key, val) {
            const b = blocks.find(x => x.id === id);
            if (b) { b.styles[key] = ['fontSize','fontWeight','padding','marginY','height','width'].includes(key) ? Number(val) : val; render(); renderProps(); }
        }

        function uploadImg(event, id) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => updateContent(id, e.target.result);
            reader.readAsDataURL(file);
        }

        function updateHTML() {
            const html = buildHTML();
            document.getElementById('htmlOutput').value = html;
        }

        function buildHTML() {
            const bodyBlocks = blocks.map(b => {
                if (b.type === 'heading') {
                    return `<h1 style="font-size:${b.styles.fontSize}px;font-weight:${b.styles.fontWeight};color:${b.styles.color};text-align:${b.styles.align};padding:${b.styles.padding}px;margin:${b.styles.marginY}px 0;">${escapeHtml(b.content)}</h1>`;
                }
                if (b.type === 'paragraph') {
                    return `<p style="font-size:${b.styles.fontSize}px;font-weight:${b.styles.fontWeight};color:${b.styles.color};text-align:${b.styles.align};padding:${b.styles.padding}px;margin:${b.styles.marginY}px 0;line-height:1.6;">${escapeHtml(b.content)}</p>`;
                }
                if (b.type === 'image') {
                    return `<div style="text-align:${b.styles.align};padding:${b.styles.padding}px;margin:${b.styles.marginY}px 0;"><img src="${b.content}" style="max-width:${b.styles.width || 100}%;border-radius:12px;" alt="img"></div>`;
                }
                if (b.type === 'button') {
                    return `<div style="text-align:${b.styles.align};padding:${b.styles.padding}px;margin:${b.styles.marginY}px 0;"><a href="#" style="display:inline-block;padding:12px 18px;border-radius:12px;background:${b.styles.buttonBg};color:${b.styles.buttonColor};font-size:${b.styles.fontSize}px;font-weight:${b.styles.fontWeight};text-decoration:none;">${escapeHtml(b.content)}</a></div>`;
                }
                if (b.type === 'divider') {
                    return `<div style="height:1px;background:#e0e0e0;margin:${b.styles.marginY || 6}px 0;"></div>`;
                }
                if (b.type === 'spacer') {
                    return `<div style="height:${b.styles.height || 16}px;"></div>`;
                }
                return '';
            }).join('\n');

            return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‚®ä»¶</title>
    <style> body { background:#E3E2DE; } </style>
</head>
<body style="margin:0;padding:20px;display:flex;justify-content:center;">
    <div style="width:100%;max-width:600px;background:#ffffff;padding:28px;border-radius:12px;">
        <img src="https://cloudflare-imgbed-1g1.pages.dev/file/eb403447697894cceee15.jpg" alt="Logo" style="width:64px;height:auto;margin-bottom:16px;">
        ${bodyBlocks}
    </div>
</body>
</html>`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text ?? '';
            return div.innerHTML;
        }

        function copyHTML() {
            const html = buildHTML();
            if (navigator.clipboard) {
                navigator.clipboard.writeText(html).then(() => alert('å·²å¤åˆ¶ HTMLï¼Œå¯ç²˜è´´åˆ°é‚®ä»¶å®¢æˆ·ç«¯')).catch(() => fallbackCopy(html));
            } else fallbackCopy(html);
        }

        function fallbackCopy(text) {
            const ta = document.createElement('textarea');
            ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
            alert('å·²å¤åˆ¶ HTML');
        }

        async function runAI() {
            const key = document.getElementById('apiKey').value.trim();
            const prompt = document.getElementById('aiPrompt').value.trim();
            if (!prompt) return alert('è¯·è¾“å…¥æç¤º');
            const target = blocks.find(b => b.id === selectedId && ['heading','paragraph'].includes(b.type));
            const baseContent = target ? target.content : '';
            const body = {
                model: 'gpt-4o-mini',
                messages: [
                    { role: 'system', content: 'ä½ æ˜¯é‚®ä»¶æ–‡æ¡ˆåŠ©æ‰‹ï¼Œä¿æŒç®€æ´ã€ä¸“ä¸šã€å‹å¥½ã€‚' },
                    { role: 'user', content: `${prompt}\nåŸæ–‡ï¼š${baseContent}` }
                ],
                temperature: 0.6
            };
            try {
                const res = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                    body: JSON.stringify(body)
                });
                if (!res.ok) throw new Error('API è°ƒç”¨å¤±è´¥');
                const data = await res.json();
                const text = data.choices?.[0]?.message?.content?.trim() || '';
                if (target) { target.content = text; render(); } else { addBlock('paragraph'); blocks[blocks.length-1].content = text; render(); }
            } catch (e) {
                alert('AI è°ƒç”¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key æˆ–ç½‘ç»œ');
            }
        }

        // init
        addBlock('heading');
        addBlock('paragraph');
        render();
    </script>
</body>
</html>